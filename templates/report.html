<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Detection Report - AI Proctoring System</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary:#2563eb; --primary-600:#1e40af; --accent:#3b82f6;
      --success:#0f9d58; --warning:#f59e0b; --danger:#d93025;
      --bg-1:#f6f8ff; --bg-2:#eef2ff; --surface:#ffffff; --ink-900:#0f172a; --ink-700:#334155; --ink-500:#64748b;
      --radius-lg:18px; --radius-md:12px; --radius-sm:10px;
      --shadow-sm:0 8px 18px rgba(15,23,42,.10); --shadow-md:0 16px 36px rgba(15,23,42,.16)
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans";background:linear-gradient(135deg,var(--bg-1),var(--bg-2));min-height:100vh;padding:20px;color:var(--ink-900)}
    .wrap{max-width:1200px;margin:0 auto;background:var(--surface);border-radius:20px;padding:36px;box-shadow:0 20px 60px rgba(15,23,42,.18)}
    h1{margin:0 0 8px;font-size:34px}
    .subtitle{margin:0 0 20px;color:var(--ink-700)}
    .summary{background:linear-gradient(135deg,#eef2ff,#e0e7ff);padding:18px;border-radius:16px;margin-bottom:20px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
    .tile{background:linear-gradient(135deg,#667eea,#3b82f6);color:#fff;padding:18px;border-radius:14px;box-shadow:var(--shadow-sm)}
    .tile .lbl{opacity:.9;text-transform:uppercase;font-size:.9em;letter-spacing:.04em}
    .tile .val{font-size:26px;font-weight:800}
    .section-title{font-size:22px;margin:18px 0 10px;padding-bottom:8px;border-bottom:3px solid var(--primary)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .info{padding:14px;background:#f7f9fc;border-radius:10px}
    .info .k{font-weight:800;color:var(--ink-700);font-size:.85em;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
    .info .v{font-weight:700}
    .warn{background:#fff6db;border-left:5px solid #f1b301;color:#7a4d00;padding:14px;border-radius:10px;margin:10px 0}
    .ok{background:#e9f7ef;border-left:5px solid #12a268;color:#0b5d3b;padding:14px;border-radius:10px;margin:10px 0}
    .table-box{overflow-x:auto;border-radius:12px;box-shadow:0 2px 8px rgba(15,23,42,.08)}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead th{position:sticky;top:0;background:var(--primary);color:#fff;text-align:left;padding:12px;border:0}
    tbody td{padding:12px;border-bottom:1px solid #edf2f7}
    tbody tr:hover{background:#f8fafc}
    .high{color:#b42318;font-weight:800}
    .med{color:#a86207;font-weight:800}
    .low{color:#147d55;font-weight:800}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:16px;padding-top:12px;border-top:1px solid #e5e7eb}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 20px;border-radius:999px;border:1px solid rgba(2,6,23,.12);background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn.primary:hover{background:var(--primary-600)}
    .btn:hover{box-shadow:0 8px 18px rgba(15,23,42,.12)}
    footer{text-align:center;color:var(--ink-700);margin-top:16px}
    @media (max-width:980px){.stats{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.wrap{padding:20px}.stats,.grid{grid-template-columns:1fr}}
    @media print{body{background:#fff;padding:0}.wrap{box-shadow:none;padding:20px}.actions{display:none}table{font-size:.9em}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üîç AI Detection Report</h1>
    <p class="subtitle">Comprehensive Session Analysis</p>

    <div class="summary">
      <h3 style="margin:0 0 8px">üìä Session Overview</h3>
      <p style="margin:0">
        This report summarizes the session that analyzed <strong>{{ data.total_frames }}</strong> frames with an average suspicion score of
        <strong>{{ "%.1f"|format(data.avg_suspicion * 100) }}%</strong>.
        {% if data.suspicion_rate < 30 %}
          The session showed <span style="background:#e9f7ef;color:#0b5d3b;padding:6px 10px;border-radius:999px;font-weight:800">LOW RISK</span>.
        {% elif data.suspicion_rate < 60 %}
          The session showed <span style="background:#fff6db;color:#7a4d00;padding:6px 10px;border-radius:999px;font-weight:800">MODERATE RISK</span>.
        {% else %}
          The session showed <span style="background:#fde8e8;color:#7a1d1d;padding:6px 10px;border-radius:999px;font-weight:800">HIGH RISK</span>.
        {% endif %}
      </p>
    </div>

    <div class="stats">
      <div class="tile"><div class="lbl">Total Frames</div><div class="val">{{ data.total_frames }}</div></div>
      <div class="tile"><div class="lbl">Average Suspicion</div><div class="val">{{ "%.1f"|format(data.avg_suspicion * 100) }}%</div></div>
      <div class="tile"><div class="lbl">Suspicious Frames</div><div class="val">{{ data.suspicious_frames }}</div></div>
      <div class="tile"><div class="lbl">Max Suspicion</div><div class="val">{{ "%.1f"|format(data.max_suspicion * 100) }}%</div></div>
    </div>

    <h2 class="section-title">‚è±Ô∏è Session Information</h2>
    <div class="grid">
      <div class="info"><div class="k">Session ID</div><div class="v">{{ data.session_id[:12] }}...</div></div>
      <div class="info"><div class="k">Start Time</div><div class="v">{{ data.start_time }}</div></div>
      <div class="info"><div class="k">End Time</div><div class="v">{{ data.end_time or 'In Progress' }}</div></div>
      <div class="info"><div class="k">Suspicion Rate</div><div class="v">{{ "%.1f"|format(data.suspicion_rate) }}%</div></div>
    </div>

    <h2 class="section-title">üë§ Behavioral Analysis</h2>
    {% if data.head_pose_warnings > 0 or data.audio_warnings > 0 %}
      <div class="warn">
        <h3 style="margin:0 0 6px">‚ö†Ô∏è Warnings Detected</h3>
        <p style="margin:0 0 8px">The following suspicious behaviors were detected during the session:</p>
        <div class="grid">
          <div class="info"><div class="k">Head Pose Warnings</div><div class="v">{{ data.head_pose_warnings }}</div></div>
          <div class="info"><div class="k">Audio Activity</div><div class="v">{{ data.audio_warnings }}</div></div>
        </div>
      </div>
    {% else %}
      <div class="ok">
        <h3 style="margin:0 0 6px">‚úÖ No Significant Warnings</h3>
        <p style="margin:0">No major behavioral anomalies were detected; proper head positioning and minimal audio activity were maintained.</p>
      </div>
    {% endif %}

    <h2 class="section-title">üì± Device Detection Summary</h2>
    <div class="grid">
      <div class="info"><div class="k">üíª Laptop Detections</div><div class="v">{{ data.device_detections.laptop }}</div></div>
      <div class="info"><div class="k">üì± Cell Phone Detections</div><div class="v">{{ data.device_detections['cell phone'] }}</div></div>
      <div class="info"><div class="k">üë• Unique Persons</div><div class="v">{{ data.unique_persons_count }}</div></div>
      <div class="info"><div class="k">‚ö†Ô∏è Total Devices</div><div class="v">{{ data.device_detections.laptop + data.device_detections['cell phone'] }}</div></div>
    </div>

    {% if data.device_detections.laptop > 0 or data.device_detections['cell phone'] > 0 %}
      <div class="warn">
        <h3 style="margin:0 0 6px">üö® Device Alert</h3>
        <p style="margin:0">
          Unauthorized devices were detected during the session.
          {% if data.device_detections.laptop > 0 %}Laptop: <strong>{{ data.device_detections.laptop }}</strong> times.{% endif %}
          {% if data.device_detections['cell phone'] > 0 %} Cell phone: <strong>{{ data.device_detections['cell phone'] }}</strong> times.{% endif %}
        </p>
      </div>
    {% endif %}

    <h2 class="section-title">üìã Frame-by-Frame Analysis</h2>
    <p style="color:var(--ink-700);margin-top:0">Showing the last {{ [20, data.frame_data|length]|min }} frames of {{ data.frame_data|length }} total analyzed frames.</p>
    <div class="table-box">
      <table>
        <thead>
          <tr>
            <th>Frame #</th>
            <th>Timestamp</th>
            <th>Suspicion</th>
            <th>Detected Class</th>
            <th>Persons</th>
            <th>Devices</th>
          </tr>
        </thead>
        <tbody>
          {% for frame in data.frame_data[-20:] %}
          <tr>
            <td><strong>#{{ frame.frame_num }}</strong></td>
            <td>{{ frame.timestamp }}</td>
            <td class="{% if frame.suspicion >= 0.7 %}high{% elif frame.suspicion >= 0.4 %}med{% else %}low{% endif %}">
              {{ "%.1f"|format(frame.suspicion * 100) }}%
            </td>
            <td>{{ frame.detected_class }}</td>
            <td>{{ frame.persons_count }}</td>
            <td>{{ frame.devices_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="actions">
      <a href="{{ url_for('assessment') }}" class="btn primary"><i class="fas fa-rotate-right"></i> Start New Session</a>
      <button onclick="window.print()" class="btn"><i class="fas fa-print"></i> Print Report</button>
    </div>
  </div>

  <footer>¬© 2025 AI Proctoring System</footer>
</body>
</html>
